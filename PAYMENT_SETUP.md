# æ”¯ä»˜åŠŸèƒ½è®¾ç½®è¯´æ˜

## ğŸš€ åŠŸèƒ½æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆStripeæ”¯ä»˜ç³»ç»Ÿï¼Œæ”¯æŒç”¨æˆ·è´­ä¹°ç§¯åˆ†å¥—é¤ã€‚åŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

- 4ä¸ªç§¯åˆ†å¥—é¤ï¼šåŸºç¡€ç‰ˆã€æ ‡å‡†ç‰ˆã€ä¸“ä¸šç‰ˆã€ä¼ä¸šç‰ˆ
- Stripeæ”¯ä»˜é›†æˆ
- æ”¯ä»˜çŠ¶æ€è·Ÿè¸ª
- ç§¯åˆ†è‡ªåŠ¨æ·»åŠ 
- Webhookå¤„ç†

## ğŸ“‹ å¥—é¤è¯¦æƒ…

| å¥—é¤ | ä»·æ ¼ | ç§¯åˆ† | é¢„è®¡AIç¼–è¾‘æ¬¡æ•° | ç‰¹è‰²åŠŸèƒ½ |
|------|------|------|----------------|----------|
| åŸºç¡€ç‰ˆ | $1.99 | 160 | 10æ¬¡ | æ ‡å‡†åˆ†è¾¨ç‡è¾“å‡ºï¼ŒåŸºç¡€æ¨¡æ¿ä½¿ç”¨ï¼Œé‚®ä»¶æ”¯æŒ |
| æ ‡å‡†ç‰ˆ | $5.99 | 550 | 36æ¬¡ | é«˜æ¸…åˆ†è¾¨ç‡è¾“å‡ºï¼Œæ‰€æœ‰åŸºç¡€æ¨¡æ¿ï¼Œä¼˜å…ˆå®¢æœæ”¯æŒ |
| ä¸“ä¸šç‰ˆ | $19.99 | 2700 | 180æ¬¡ | 4Kè¶…é«˜æ¸…è¾“å‡ºï¼Œæ‰€æœ‰é«˜çº§æ¨¡æ¿ï¼Œæ‰¹é‡å¤„ç†åŠŸèƒ½ï¼Œä¸“å±å®¢æœæ”¯æŒ |
| ä¼ä¸šç‰ˆ | $49.9 | 9000 | 600æ¬¡ | 8Kè¶…é«˜æ¸…è¾“å‡ºï¼Œå›¢é˜Ÿåä½œåŠŸèƒ½ï¼ŒAPIæ¥å£è®¿é—®ï¼Œä¸“å±å®¢æˆ·ç»ç† |

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env.local` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```bash
# Stripeé…ç½®
STRIPE_SECRET_KEY=sk_test_... # ä»Stripe Dashboardè·å–
STRIPE_PUBLISHABLE_KEY=pk_test_... # ä»Stripe Dashboardè·å–
STRIPE_WEBHOOK_SECRET=whsec_... # ä»Stripe Dashboardè·å–

# Supabaseé…ç½®
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾ç½®

### 1. æ‰§è¡ŒSQLè„šæœ¬

åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œ `database-schema.sql` æ–‡ä»¶ä¸­çš„SQLè¯­å¥ï¼Œåˆ›å»ºå¿…è¦çš„è¡¨å’Œå‡½æ•°ã€‚

### 2. è¡¨ç»“æ„è¯´æ˜

- `stripe_payment_intents`: å­˜å‚¨Stripeæ”¯ä»˜æ„å›¾
- `user_credits`: ç”¨æˆ·ç§¯åˆ†ä½™é¢
- `credit_transactions`: ç§¯åˆ†äº¤æ˜“è®°å½•

## ğŸ”— Stripeè®¾ç½®

### 1. åˆ›å»ºStripeè´¦æˆ·

1. è®¿é—® [Stripeå®˜ç½‘](https://stripe.com) æ³¨å†Œè´¦æˆ·
2. å®Œæˆè´¦æˆ·éªŒè¯

### 2. è·å–APIå¯†é’¥

1. ç™»å½•Stripe Dashboard
2. è¿›å…¥"å¼€å‘è€…" > "APIå¯†é’¥"
3. å¤åˆ¶"å¯å‘å¸ƒå¯†é’¥"å’Œ"å¯†é’¥"

### 3. è®¾ç½®Webhook

1. è¿›å…¥"å¼€å‘è€…" > "Webhook"
2. æ·»åŠ ç«¯ç‚¹ï¼š`https://yourdomain.com/api/webhooks/stripe`
3. é€‰æ‹©äº‹ä»¶ï¼š`payment_intent.succeeded`, `payment_intent.payment_failed`, `payment_intent.canceled`
4. å¤åˆ¶Webhookç­¾åå¯†é’¥

### 4. åˆ›å»ºä»·æ ¼äº§å“

åœ¨Stripe Dashboardä¸­ä¸ºæ¯ä¸ªå¥—é¤åˆ›å»ºä»·æ ¼äº§å“ï¼Œå¹¶æ›´æ–° `config/credit-plans.ts` ä¸­çš„ `stripe_price_id`ã€‚

## ğŸ¯ ä½¿ç”¨æµç¨‹

### ç”¨æˆ·è´­ä¹°æµç¨‹

1. ç”¨æˆ·é€‰æ‹©å¥—é¤å¹¶ç‚¹å‡»"ç«‹å³è´­ä¹°"
2. ç³»ç»Ÿåˆ›å»ºæ”¯ä»˜æ„å›¾
3. æ‰“å¼€æ”¯ä»˜å¼¹çª—ï¼Œç”¨æˆ·è¾“å…¥ä¿¡ç”¨å¡ä¿¡æ¯
4. ç”¨æˆ·ç¡®è®¤æ”¯ä»˜
5. Stripeå¤„ç†æ”¯ä»˜
6. æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨æ·»åŠ ç§¯åˆ†åˆ°ç”¨æˆ·è´¦æˆ·

### æ”¯ä»˜çŠ¶æ€è·Ÿè¸ª

- `requires_payment_method`: ç­‰å¾…æ”¯ä»˜æ–¹å¼
- `requires_confirmation`: ç­‰å¾…ç¡®è®¤
- `requires_action`: éœ€è¦é¢å¤–æ“ä½œ
- `processing`: å¤„ç†ä¸­
- `requires_capture`: ç­‰å¾…æ•è·
- `canceled`: å·²å–æ¶ˆ
- `succeeded`: æ”¯ä»˜æˆåŠŸ

## ğŸ› ï¸ å¼€å‘è¯´æ˜

### æ–‡ä»¶ç»“æ„

```
â”œâ”€â”€ types/payment.ts              # æ”¯ä»˜ç±»å‹å®šä¹‰
â”œâ”€â”€ config/credit-plans.ts        # å¥—é¤é…ç½®
â”œâ”€â”€ lib/stripe.ts                 # StripeæœåŠ¡
â”œâ”€â”€ components/PaymentModal.tsx   # æ”¯ä»˜å¼¹çª—ç»„ä»¶
â”œâ”€â”€ app/api/payments/            # æ”¯ä»˜API
â”‚   â”œâ”€â”€ create-payment-intent/   # åˆ›å»ºæ”¯ä»˜æ„å›¾
â”‚   â””â”€â”€ confirm/                 # ç¡®è®¤æ”¯ä»˜
â””â”€â”€ app/api/webhooks/stripe/     # Stripe Webhook
```

### ä¸»è¦ç»„ä»¶

- `PaymentModal`: æ”¯ä»˜å¼¹çª—ç»„ä»¶
- `CreditPlan`: å¥—é¤ç±»å‹å®šä¹‰
- `createPaymentIntent`: åˆ›å»ºæ”¯ä»˜æ„å›¾API
- `confirmPayment`: ç¡®è®¤æ”¯ä»˜API

### è‡ªå®šä¹‰é…ç½®

å¯ä»¥åœ¨ `config/credit-plans.ts` ä¸­ä¿®æ”¹å¥—é¤ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä»·æ ¼ã€ç§¯åˆ†æ•°é‡ã€æè¿°ç­‰ã€‚

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•å¡å·

Stripeæä¾›ä»¥ä¸‹æµ‹è¯•å¡å·ï¼š

- æˆåŠŸæ”¯ä»˜ï¼š`4242 4242 4242 4242`
- éœ€è¦éªŒè¯ï¼š`4000 0025 0000 3155`
- æ”¯ä»˜å¤±è´¥ï¼š`4000 0000 0000 0002`

### æµ‹è¯•ç¯å¢ƒ

ç¡®ä¿åœ¨Stripe Dashboardä¸­ä½¿ç”¨æµ‹è¯•æ¨¡å¼ï¼Œé¿å…äº§ç”ŸçœŸå®è´¹ç”¨ã€‚

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**: æ°¸è¿œä¸è¦åœ¨å‰ç«¯æš´éœ²Stripeç§é’¥
2. **Webhook**: ç¡®ä¿Webhookç«¯ç‚¹å¯å…¬å¼€è®¿é—®
3. **é”™è¯¯å¤„ç†**: å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
4. **æµ‹è¯•**: åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å……åˆ†æµ‹è¯•æ”¯ä»˜æµç¨‹
5. **åˆè§„æ€§**: ç¡®ä¿ç¬¦åˆå½“åœ°æ”¯ä»˜æ³•è§„è¦æ±‚

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®
2. æ•°æ®åº“è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
3. Stripe APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
4. Webhookæ˜¯å¦æ­£ç¡®é…ç½®
5. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

## ğŸ”„ æ›´æ–°æ—¥å¿—

- v1.0.0: åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºç¡€æ”¯ä»˜åŠŸèƒ½
- æ”¯æŒ4ä¸ªç§¯åˆ†å¥—é¤
- é›†æˆStripeæ”¯ä»˜ç³»ç»Ÿ
- å®Œæ•´çš„æ”¯ä»˜æµç¨‹
- Webhookå¤„ç†
